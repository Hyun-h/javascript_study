# 웹브라우저 동작원리

```
오늘의 교훈 : 웹이 느린 현상이 보일 때는 stack과 queue를 바쁘게 하지 않았는지 양심에 손을 얹고 생각해봅시다.
```

왜 브라우저의 동작원리를 알아야 하죠?  
당연한 소리 같겠지만 HTML, CSS, JavaScript 는 웹에서 돌아간다.  
자바스크립트는 한 번에 하나의 태스크만 처리할 수 있는 싱글 스레드 방식이다. (이때 싱글 스레드 방식으로 동작하는 것은 브라우저가 아니라 자바스크립트 엔진이다.) 하지만 애니메이션 효과를 통해 이벤트를 처리한다던가, 서버에서 데이터를 가지고 와서 렌더링을 하는 걸 보면 태스크가 동시에 처리되는 것처럼 느껴진다.  
이와 같이 자바스크립트의 동시성을 지원하는 것이 브라우저에 내장되어 있는 이벤트 루프이다.

---

## 왜 이런 현상이 일어날까?

다른 언어에서 1초 정도 쉬고 실행을 하는 코드를 실행한다면

```python
# Python ver.
print(1 + 1)
time.sleep(1)
print(2 + 2)
```

위에서 아래로 한 줄 한 줄 실행해 주면서 2가 출력된 다음 1초동안 정지 되었다가 4가 출력된다.

자바스크립트에서는

```js
console.log(1 + 1);
setTimeout(function () {
  console.log(2 + 2);
}, 1000);
console.log(3 + 3);
```

2 출력 -> 6 출력 -> 4 출력  
1초 정지하고 4를 출력해주기는 하는데 빠르게 처리할 수 있는 다른 코드를 먼저 실행시켜준다.

## 동작원리를 이해해보자!

대부분의 자바스크립트 엔진은 힙과 콜 스택 두 개의 영역으로 이루어져 있다. 단순한 태스크가 요청이 되면 콜 스택을 통해 요청된 작업을 하나하나 처리한다. 콜 스택은 하나이고, 하나씩 처리하기 때문에 자바스크립트를 single threaded language 라고 한다.  
콜 스택이 처리를 하다가 변수를 마주치게 되면 객체의 메모리가 저장되는 메모리 공간인 힙에서 가져다가 쓴다.

콜 스택이 하나씩 실행을 하다가 DOM API, Timer Function, HTTP request 과 같이 바로 처리할 수 없는 코드가 나올 때가 있다. 이를 처리하기 위해 브라우저 환경은 태스크 큐와 이벤트 루프를 제공한다.

콜 스택이 처리할 수 없는 코드를 태스크 큐로 이동시킨다. 태스크 큐는 비동기 함수의 콜백 함수 또는 이벤트 핸들러가 일시적으로 보관되는 영역이다.  
이때 이벤트 루프에서 콜 스택과 태스크 큐를 수시로 확인한다. 만약 콜 스택이 비어있고 태스크 큐에 대기 중인 함수가 있다면 순차적으로 태스크 큐에 대기 중인 함수를 콜 스택으로 이동시킨다.

```js
//1
console.log(1 + 1);
//2
setTimeout(function () {
  console.log(2 + 2), 1000;
});
//3
console.log(3 + 3);
```

다시 예제로 돌아가서 동작원리로 이어서 설명해보자.  
콜 스택에 1, 2, 3이 순차적으로 들어온다.  
1의 실행이 끝나고 2의 차례가 되었을 때 평가와 실행은 가능하지만 처리는 할 수 없다. 이때 2의 타이머 설정이 만료되면 콜백 함수를 태스크 큐에 넣는 건 브라우저의 역할이다. 2가 처리되는동안 3이 처리가 되고 콜 스택이 비게 되면 이벤트 루프는 태스크 큐에 대기 중이던 2의 콜백함수를 콜 스택에 넣어주고, 콜 스택에서 실행이 된다.

## 결론

자바스크립트의 이런 원리 때문에 콜 스택이 오랫동안 비지 않는 오래된 연산이 있고,
태스크 큐에 처리해야 할 게 쌓여있다면 웹의 속도는 저하가 되고 브라우저 프리징의 원인이 된다. 그런 일이 벌어지지 않게 효율적으로 코드를 짜도록 늘 공부하고 연습하자.
